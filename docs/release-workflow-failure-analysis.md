# Release Workflow Failure Analysis

## Issue

The Release workflow failed on run #21304489526 (tag v0.11.2) at the "Start MCP gateway" step.

**Workflow**: `release.lock.yml` (generated by GitHub agentic workflows system)
**Failed Job**: `agent` (step 16: "Start MCP gateway")  
**Run URL**: https://github.com/githubnext/gh-aw-firewall/actions/runs/21304489526

## Root Cause

The MCP Gateway container (from `githubnext/gh-aw-mcpg:v0.0.59`) is trying to bind to port 80, which requires root/elevated privileges on Linux systems. The failure manifests as:

```
[INFO] Gateway will listen on 0.0.0.0:80
...
Port 80 does not appear to be listening
##[error]Process completed with exit code 1.
```

### Technical Details

1. The gateway starts with `docker run --network host`
2. With `--network host`, the container shares the host's network namespace
3. Binding to port 80 (a privileged port < 1024) requires:
   - Container running as root, OR
   - Container with `NET_BIND_SERVICE` capability
4. The current container configuration lacks these privileges
5. Health check at `http://localhost:80/health` fails after 120 retries (2 minutes)
6. curl exit code 7: "Failed to connect to host"

### Evidence from Logs

```
2026/01/23 23:25:37 [INFO] Gateway will listen on 0.0.0.0:80
2026/01/23 23:25:37 Gateway started with PID: 3678
2026/01/23 23:25:37 Gateway process confirmed running (PID: 3678)
...
2026/01/23 23:27:42 Curl exit code: 7
2026/01/23 23:27:42 Health endpoint HTTP code: 000
2026/01/23 23:27:42 ERROR: Gateway failed to become ready
```

## Impact

- **Scope**: Affects all agentic workflow executions that require the MCP Gateway
- **Severity**: **Critical** - Blocks all automated releases
- **Affected Component**: External dependency (`githubnext/gh-aw/actions/setup@v0.37.3`)

## Solution Options

### Option 1: Use Non-Privileged Port (Recommended)

The MCP Gateway should be configured to use a non-privileged port (e.g., 8080 instead of 80).

**Action Required**: This needs to be fixed in the `githubnext/gh-aw` repository, specifically:
- MCP Gateway container default port configuration
- Or: Add configuration option to specify custom port

### Option 2: Grant NET_BIND_SERVICE Capability

Add the `NET_BIND_SERVICE` capability to the gateway container:

```yaml
docker run --cap-add=NET_BIND_SERVICE --network host ...
```

**Note**: This requires changes to the `githubnext/gh-aw/actions/setup` action.

### Option 3: Run Gateway as Root

Run the gateway container as root user (not recommended for security reasons):

```yaml
docker run --user root --network host ...
```

## Workaround

Until the upstream issue is fixed, the Release workflow cannot complete successfully. Manual release process may be required:

1. Create release manually via GitHub UI
2. Build and push Docker images manually
3. Create and upload release artifacts manually

Alternatively, if there's a configuration option in the agentic workflows system to specify a custom gateway port, that should be used.

## Recommended Actions

### Immediate Solution: Upgrade Setup Action

The current version in use is **v0.37.3** (from 2025), but the latest is **v0.37.26** (released 2026-01-27). Many improvements have been made since v0.37.3, though it's unclear if the port binding issue was specifically fixed.

**Action**: Update `.github/aw/actions-lock.json` to use a newer version of the setup action.

```bash
# Using gh-aw CLI (if available)
gh aw upgrade

# Or manually update the version in .github/aw/actions-lock.json
# Change from v0.37.3 to v0.37.26 (or latest)
```

### Long-term Solutions

1. **Report to githubnext/gh-aw**: If upgrading doesn't fix the issue, file an issue in the `githubnext/gh-aw` repository about the MCP Gateway port binding failure
2. **Check for Configuration**: Review if there's a way to configure a custom port for the MCP Gateway
3. **Alternative**: Use non-privileged port (8080) instead of port 80 for MCP Gateway

## Related Files

- `.github/aw/actions-lock.json` - Contains locked version of `githubnext/gh-aw/actions/setup@v0.37.3` (needs update to v0.37.26+)
- `.github/workflows/release.yml` - Original release workflow (non-agentic)
- Agentic workflow source is in `githubnext/gh-aw` repository (not in this repo)

## Version Information

- **Current version**: `githubnext/gh-aw/actions/setup@v0.37.3`
- **Latest version**: `githubnext/gh-aw/actions/setup@v0.37.26` (as of 2026-01-27)
- **MCP Gateway image**: `ghcr.io/githubnext/gh-aw-mcpg:v0.0.59`

## Status

- [x] Issue identified and documented
- [x] Latest version identified (v0.37.26)
- [ ] Upgrade to latest version
- [ ] Verify fix with test workflow
- [ ] Release workflow succeeds

Last Updated: 2026-01-27
